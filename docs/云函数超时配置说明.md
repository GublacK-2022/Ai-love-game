# 云函数超时配置说明

## 问题背景

DeepSeek API 的响应时间通常在 2-5 秒，但微信云函数默认超时时间只有 **3 秒**。这导致即使 API 调用成功，云函数也会因超时而返回错误。

## 当前代码配置

代码中已经做了以下优化：

### 1. 前端设置（已生效）
在 [pages/chat/chat.js](../pages/chat/chat.js) 中，调用云函数时设置了 20 秒超时：

```javascript
const res = await wx.cloud.callFunction({
  name: 'chat',
  data: { /* ... */ },
  timeout: 20000  // ← 20 秒超时
})
```

### 2. 云函数内部请求超时（已生效）
在 [cloudfunctions/chat/index.js](../cloudfunctions/chat/index.js) 中，API 请求设置了 2.5 秒超时：

```javascript
req.setTimeout(2500, () => {
  console.error('API请求超时 (2.5秒)')
  req.destroy()
  reject(new Error('AI响应超时'))
})
```

### 3. 云函数配置文件（❌ 不生效）
尝试在 `cloudfunctions/chat/config.json` 中设置 `timeout: 20`，但这个配置**不会生效**。

## ✅ 正确配置方法

云函数的超时时间需要在**云开发控制台**手动配置，无法通过配置文件修改。

### 配置步骤

#### 1. 打开云开发控制台
- 在微信开发者工具中，点击"云开发"按钮
- 或点击工具栏"云开发 -> 云开发控制台"

#### 2. 进入云函数管理
- 点击左侧"云函数"
- 找到 `chat` 云函数，点击进入详情

#### 3. 配置超时时间
- 点击"版本管理"或"配置"标签
- 找到"超时时间"设置
- 将超时时间从 **3 秒** 改为 **20 秒**
- 点击"保存"

#### 4. 重新部署（可选）
一般保存后会自动生效，如果没有生效：
- 在微信开发者工具中，右键点击 `chat` 云函数
- 选择"上传并部署：云端安装依赖"

## 验证配置

配置成功后，可以通过以下方式验证：

1. 在聊天界面发送一条消息
2. 查看云函数日志（云开发控制台 -> 云函数 -> chat -> 日志）
3. 确认没有"timeout"相关的错误
4. 正常情况下，日志会显示：
   ```
   开始调用 DeepSeek API
   API 响应时间: 2500ms
   API 调用成功
   ```

## 性能优化建议

### 已完成的优化
- ✅ 减少 max_tokens（200，约 60-120 字）
- ✅ 设置合理的温度参数（0.8）
- ✅ 限制对话历史（最近 10 条）
- ✅ 简化 System Prompt

### 可选优化
- 🔄 使用流式响应（stream）加快首字响应
- 🔄 实现客户端缓存，减少重复请求
- 🔄 添加重试机制，失败后自动重试

## 降级方案

代码中已实现降级方案，当 API 超时时返回预设回复：

```javascript
const fallbackReplies = {
  '打招呼': '【他抬起头看向你】"嗯。"',
  '介绍自己': '【他微微颔首】"我知道。"',
  default: '【他的目光在你身上停留片刻】"继续说。"'
}
```

## ⚠️ 注意事项

1. **必须手动配置**：config.json 中的 timeout 设置不会生效
2. **配置位置**：必须在云开发控制台网页端配置
3. **生效时间**：保存后立即生效，无需重新上传云函数
4. **免费额度**：注意云函数的执行时间会计入免费额度

## 常见问题

### Q: 为什么 config.json 不生效？
A: 微信云开发的云函数配置需要在控制台设置，配置文件只支持部分参数（如环境变量），不包括超时时间。

### Q: 超时时间设置多少合适？
A: 根据 DeepSeek API 的响应时间（通常 2-5 秒），建议设置为 **15-20 秒**。太短会导致超时，太长会影响用户体验。

### Q: 前端的 timeout 参数有用吗？
A: 有用！前端的 timeout 参数控制客户端等待时间。但云函数如果先超时，客户端的设置也无效。所以两边都要配置。

## 相关文档

- [微信云开发文档 - 云函数配置](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions/config.html)
- [DeepSeek API 文档](https://platform.deepseek.com/api-docs/)
