# 数据库权限配置说明

## 为什么需要配置权限？

为了保护用户隐私，确保每个用户只能看到自己的聊天记录，需要正确配置数据库集合的权限。

## 配置步骤

### 1. 打开云开发控制台
- 在微信开发者工具中，点击"云开发"按钮
- 或点击工具栏"云开发 -> 云开发控制台"

### 2. 进入数据库管理
- 点击左侧"数据库"
- 找到需要配置权限的集合

### 3. 配置各集合权限

#### chat_sessions（对话会话表）
- **推荐权限**：仅创建者可读写
- **说明**：每个用户只能看到自己创建的会话
- **设置方法**：
  1. 点击集合右侧"权限设置"
  2. 选择"仅创建者可读写"
  3. 保存

#### chat_history（聊天历史表）
- **推荐权限**：仅创建者可读写
- **说明**：每个用户只能看到自己的聊天历史
- **设置方法**：同上

#### characters（角色信息表）
- **推荐权限**：所有用户可读，仅管理员可写
- **说明**：角色信息是公开的，所有用户都可以查看，但只有管理员能修改
- **设置方法**：
  1. 点击集合右侧"权限设置"
  2. 选择"自定义安全规则"
  3. 设置规则：
  ```json
  {
    "read": true,
    "write": "doc._openid == 'your-admin-openid'"
  }
  ```
  或者简单设置为"所有用户可读，仅创建者可写"

## 当前代码的权限机制

### 云函数侧（自动隔离）
云函数在创建和查询 `chat_sessions` 和 `chat_history` 时，都会使用 `userId` 字段来标识用户：

```javascript
// 创建 session
await db.collection('chat_sessions').add({
  data: {
    userId: wxContext.OPENID,  // ← 用户标识
    characterId: characterId,
    // ...
  }
})

// 查询 session
await db.collection('chat_sessions').where({
  userId: wxContext.OPENID,      // ← 只查询当前用户的数据
  characterId: characterId
}).get()
```

### 前端侧（依赖权限设置）
前端查询历史时使用 `characterId` 查询，依赖数据库权限自动过滤：

```javascript
// 如果权限设置为"仅创建者可读写"
// 用户只能看到自己创建的记录
await db.collection('chat_sessions')
  .where({ characterId: this.data.characterId })
  .get()
```

## 验证权限配置

配置完成后，可以通过以下方式验证：

1. 用两个不同的微信号登录小程序
2. 分别与同一个角色聊天
3. 切换回第一个微信号
4. 确认看不到第二个微信号的聊天记录

## ⚠️ 安全提示

✅ **正确配置**：
- chat_sessions 和 chat_history 设为"仅创建者可读写"
- 云函数使用 userId 字段隔离数据
- 不同用户无法看到对方的聊天记录

❌ **错误配置**：
- 设置为"所有用户可读写"
- 用户可以看到所有人的聊天记录
- 严重的隐私泄露风险

## 注意事项

1. **数据迁移**：如果之前的数据没有 `userId` 字段，需要手动添加或清空数据重新开始
2. **管理后台**：如果需要管理后台查看所有用户数据，应创建独立的云函数，使用管理员权限
3. **数据备份**：建议定期备份数据库，避免误操作导致数据丢失
