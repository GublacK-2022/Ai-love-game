# 上线前检查清单

## ✅ 已完成

### 🔴 必须修复（已全部完成）
- [x] **API Key 安全问题**
  - 已改为环境变量 `process.env.DEEPSEEK_API_KEY`
  - 创建了配置说明文档：[环境变量配置说明.md](../cloudfunctions/chat/环境变量配置说明.md)
  - ⚠️ **操作提示**：需要在云控制台配置环境变量后重新上传云函数

- [x] **聊天记录保存**
  - 修复了 `sendMessage()` 不保存聊天记录的问题
  - 添加了详细的保存日志

- [x] **用户数据隔离**
  - 场景选择通过云函数创建 session，确保带 `userId`
  - 创建了数据库权限配置文档：[数据库权限配置说明.md](./数据库权限配置说明.md)
  - ⚠️ **操作提示**：需要在云控制台设置数据库权限为"仅创建者可读写"

- [x] **云函数超时配置**
  - 代码已设置 20 秒超时
  - 创建了配置说明文档：[云函数超时配置说明.md](./云函数超时配置说明.md)
  - ⚠️ **操作提示**：需要在云控制台手动配置超时时间为 20 秒

### 🟡 建议优化（已全部完成）
- [x] **错误提示优化**
  - 将技术化错误改为用户友好提示
  - "AI 思考超时" → "TA正在思考中..."

- [x] **隐私协议**
  - 创建了完整的隐私政策页面
  - 首次启动时强制用户阅读并同意
  - 符合小程序上线要求

- [x] **调试日志管理**
  - 创建了 utils/config.js 统一管理调试开关
  - 封装了 logger 工具函数
  - 可一键切换生产/开发模式

---

## ⚠️ 上线前必须操作

### 1. 云函数环境变量配置
```
位置：云开发控制台 -> 云函数 -> chat -> 配置 -> 环境变量
变量名：DEEPSEEK_API_KEY
变量值：sk-c0e0579bf1d946a5a95384e0b7ea5124
```
配置后需重新上传云函数。

### 2. 云函数超时配置
```
位置：云开发控制台 -> 云函数 -> chat -> 配置 -> 超时时间
设置为：20 秒
```

### 3. 数据库权限配置
```
chat_sessions: 仅创建者可读写
chat_history: 仅创建者可读写
characters: 所有用户可读，仅管理员可写
```

### 4. 关闭调试模式（可选）
编辑 `utils/config.js`，将 `DEBUG_MODE` 改为 `false`：
```javascript
const DEBUG_MODE = false  // 生产环境
```

### 5. 测试流程
- [ ] 清除本地数据，模拟新用户
- [ ] 确认隐私政策弹窗正常显示
- [ ] 同意隐私政策后能正常进入
- [ ] 测试选择角色和场景
- [ ] 发送消息，确认 AI 正常回复
- [ ] 退出后重新进入，确认历史记录正常加载
- [ ] 用另一个微信号测试，确认数据隔离
- [ ] 快速连续发送消息，测试频率限制

---

## 🟢 可选优化（未实现）

以下功能可以在后续版本中添加：

### 1. 分享功能
- [ ] 添加 `onShareAppMessage` 实现分享
- [ ] 设计分享卡片和分享文案

### 2. 用户反馈功能
- [ ] 添加反馈入口（设置页面）
- [ ] 收集用户建议和bug反馈

### 3. 数据统计
- [ ] 统计日活跃用户
- [ ] 统计消息发送量
- [ ] 统计各角色受欢迎程度

### 4. 性能优化
- [ ] Session 缓存机制（已添加字段，未完全实现）
- [ ] 历史消息分页加载
- [ ] 图片懒加载

### 5. 管理后台
- [ ] 角色管理界面
- [ ] 场景管理界面
- [ ] 用户数据查看

### 6. 更多功能
- [ ] 多语言支持
- [ ] 深色模式
- [ ] 语音输入
- [ ] 角色语音
- [ ] 更多角色和场景

---

## 📋 小程序提审准备

### 提审材料
- [ ] 小程序图标（1024x1024px）
- [ ] 小程序简介
- [ ] 小程序截图（至少3张）
- [ ] 小程序类目：社交 - 聊天工具 或 娱乐 - 在线游戏
- [ ] 隐私政策链接（可使用小程序内页面）

### 注意事项
1. **内容合规**：
   - AI 生成内容需符合平台规范
   - 避免涉及敏感话题
   - 建议添加内容审核机制

2. **功能完整性**：
   - 确保所有功能正常运行
   - 无明显bug和崩溃
   - 加载速度合理

3. **用户隐私**：
   - 隐私政策完整准确
   - 数据收集符合规范
   - 用户可删除自己的数据

4. **性能要求**：
   - 首屏加载时间 < 3秒
   - 云函数响应时间 < 5秒
   - 内存占用合理

---

## 🎯 上线后监控

上线后需要关注：
- 云函数调用量和费用
- DeepSeek API 调用量和费用
- 云数据库存储量
- 用户反馈和评分
- 崩溃率和错误日志

---

## 📞 支持

如有问题，请在 GitHub Issues 中反馈：
https://github.com/GublacK-2022/Ai-love-game/issues
