<!--pages/chat/chat.wxml-->
<view class="chat-container">
  <!-- åŠ è½½çŠ¶æ€æç¤º -->
  <view wx:if="{{isLoading}}" class="loading-container">
    <view class="loading-card">
      <view class="loading-icon"></view>
      <text class="loading-text">åŠ è½½å¯¹è¯å†å²ä¸­...</text>
    </view>
  </view>

  <!-- ğŸ­ åœºæ™¯é€‰æ‹©å™¨ -->
  <view wx:if="{{showSceneSelector}}" class="scene-selector-overlay">
    <view class="scene-selector-container">
      <view class="scene-selector-header">
        <text class="scene-selector-title">é€‰æ‹©ä½ çš„æ•…äº‹å¼€å§‹</text>
        <text class="scene-selector-subtitle">ä¸{{character.name}}çš„ç›¸é‡...</text>
      </view>

      <scroll-view class="scene-list" scroll-y>
        <view
          wx:for="{{availableScenes}}"
          wx:key="scene"
          class="scene-card"
          data-scene="{{item.scene}}"
          bindtap="selectScene"
          hover-class="scene-card-hover"
        >
          <view class="scene-card-header">
            <text class="scene-title">{{item.title}}</text>
            <view class="scene-keywords">
              <text
                wx:for="{{item.keywords}}"
                wx:key="*this"
                wx:for-item="keyword"
                class="keyword-tag"
              >
                {{keyword}}
              </text>
            </view>
          </view>
          <text class="scene-preview">{{item.content}}</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- é¡¶éƒ¨è§’è‰²ä¿¡æ¯æ  -->
  <view class="header">
    <view class="character-info">
      <image class="avatar" src="{{character.avatar}}" mode="aspectFill" />
      <view class="info">
        <text class="name">{{character.name}}</text>
        <text class="status">åœ¨çº¿</text>
      </view>
    </view>
    
    <!-- å¥½æ„Ÿåº¦æ˜¾ç¤º -->
    <view class="affection-bar">
      <view class="affection-label">
        <text>å¥½æ„Ÿåº¦</text>
        <text class="affection-value">{{affection}}</text>
      </view>
      <view class="progress-bg">
        <view class="progress-fill" style="width: {{affection + '%'}}"></view>
      </view>
    </view>
  </view>

  <!-- æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view 
    class="message-list" 
    scroll-y 
    scroll-into-view="{{scrollToView}}"
    scroll-with-animation
  >
    <view wx:for="{{messages}}" wx:key="index" class="message-item" id="msg-{{index}}">
      <!-- AIæ¶ˆæ¯ - åˆ†æ®µæ¸²æŸ“ -->
      <view wx:if="{{item.role === 'assistant'}}" class="message ai-message">
        <image class="msg-avatar" src="{{character.avatar}}" mode="aspectFill" />
        <view class="bubble ai-bubble">
          <!-- ğŸ® éå† parsedContent è¿›è¡Œåˆ†æ®µæ˜¾ç¤º -->
          <view wx:if="{{item.parsedContent && item.parsedContent.length > 0}}">
            <block wx:for="{{item.parsedContent}}" wx:for-item="segment" wx:key="index">
              <!-- å™äº‹éƒ¨åˆ†ï¼šç°è‰²å°å­—ï¼Œå¸¦ã€ã€‘ -->
              <text wx:if="{{segment.type === 'narrative'}}" class="narrative-text">ã€{{segment.text}}ã€‘</text>
              <!-- å¯¹è¯éƒ¨åˆ†ï¼šæ­£å¸¸å¤§å°ï¼Œå¸¦"" -->
              <text wx:elif="{{segment.type === 'dialogue'}}" class="dialogue-text">"{{segment.text}}"</text>
            </block>
          </view>
          <!-- å…¼å®¹æ—§æ ¼å¼ï¼šå¦‚æœæ²¡æœ‰ parsedContentï¼Œæ˜¾ç¤ºåŸå§‹å†…å®¹ -->
          <text wx:else>{{item.content}}</text>
        </view>
      </view>

      <!-- ç”¨æˆ·æ¶ˆæ¯ -->
      <view wx:else class="message user-message">
        <view class="bubble user-bubble">
          <text>{{item.content}}</text>
        </view>
        <view class="msg-avatar user-avatar-placeholder">æˆ‘</view>
      </view>
    </view>

    <!-- AIæ€è€ƒä¸­ -->
    <view wx:if="{{isThinking}}" class="message ai-message">
      <image class="msg-avatar" src="{{character.avatar}}" mode="aspectFill" />
      <view class="bubble ai-bubble thinking">
        <text class="dot"></text>
        <text class="dot"></text>
        <text class="dot"></text>
      </view>
    </view>

    <!-- å ä½ï¼Œç¡®ä¿æœ€åä¸€æ¡æ¶ˆæ¯å¯è§ -->
    <view style="height: 20px;"></view>
  </scroll-view>

  <!-- è¾“å…¥æ¡†åŒºåŸŸ -->
  <view class="input-container">
    <!-- ğŸ® å¿«æ·äº’åŠ¨é€‰é¡¹ -->
    <scroll-view
      wx:if="{{quickActions.length > 0}}"
      class="quick-actions"
      scroll-x
      show-scrollbar="{{false}}"
    >
      <view class="quick-actions-list">
        <button
          wx:for="{{quickActions}}"
          wx:key="*this"
          class="quick-action-btn"
          data-text="{{item}}"
          bindtap="selectQuickAction"
          hover-class="quick-action-hover"
        >
          {{item}}
        </button>
      </view>
    </scroll-view>

    <!-- è¾“å…¥æ¡† -->
    <view class="input-bar">
      <input
        class="input-field"
        type="text"
        placeholder="è¯´ç‚¹ä»€ä¹ˆ..."
        value="{{inputText}}"
        bindinput="onInput"
        confirm-type="send"
        bindconfirm="sendMessage"
        adjust-position="{{false}}"
      />
      <button
        class="send-btn {{inputText ? 'active' : ''}}"
        bindtap="sendMessage"
        disabled="{{!inputText || isThinking}}"
      >
        å‘é€
      </button>
    </view>
  </view>
</view>