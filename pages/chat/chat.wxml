<!--pages/chat/chat.wxml-->
<view class="chat-container">
  <!-- 加载状态提示 -->
  <view wx:if="{{isLoading}}" class="loading-container">
    <view class="loading-card">
      <view class="loading-icon"></view>
      <text class="loading-text">加载对话历史中...</text>
    </view>
  </view>

  <!-- 🎭 场景选择器 -->
  <view wx:if="{{showSceneSelector}}" class="scene-selector-overlay">
    <view class="scene-selector-container">
      <view class="scene-selector-header">
        <text class="scene-selector-title">选择你的故事开始</text>
        <text class="scene-selector-subtitle">与{{character.name}}的相遇...</text>
      </view>

      <scroll-view class="scene-list" scroll-y>
        <view
          wx:for="{{availableScenes}}"
          wx:key="scene"
          class="scene-card"
          data-scene="{{item.scene}}"
          bindtap="selectScene"
          hover-class="scene-card-hover"
        >
          <view class="scene-card-header">
            <text class="scene-title">{{item.title}}</text>
            <view class="scene-keywords">
              <text
                wx:for="{{item.keywords}}"
                wx:key="*this"
                wx:for-item="keyword"
                class="keyword-tag"
              >
                {{keyword}}
              </text>
            </view>
          </view>
          <text class="scene-preview">{{item.content}}</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- 顶部角色信息栏 -->
  <view class="header">
    <view class="character-info">
      <image class="avatar" src="{{character.avatar}}" mode="aspectFill" />
      <view class="info">
        <text class="name">{{character.name}}</text>
        <text class="status">在线</text>
      </view>
    </view>
    
    <!-- 好感度显示 -->
    <view class="affection-bar">
      <view class="affection-label">
        <text>好感度</text>
        <text class="affection-value">{{affection}}</text>
      </view>
      <view class="progress-bg">
        <view class="progress-fill" style="width: {{affection + '%'}}"></view>
      </view>
    </view>
  </view>

  <!-- 消息列表 -->
  <scroll-view 
    class="message-list" 
    scroll-y 
    scroll-into-view="{{scrollToView}}"
    scroll-with-animation
  >
    <view wx:for="{{messages}}" wx:key="index" class="message-item" id="msg-{{index}}">
      <!-- AI消息 - 分段渲染 -->
      <view wx:if="{{item.role === 'assistant'}}" class="message ai-message">
        <image class="msg-avatar" src="{{character.avatar}}" mode="aspectFill" />
        <view class="bubble ai-bubble">
          <!-- 🎮 遍历 parsedContent 进行分段显示 -->
          <view wx:if="{{item.parsedContent && item.parsedContent.length > 0}}">
            <block wx:for="{{item.parsedContent}}" wx:for-item="segment" wx:key="index">
              <!-- 叙事部分：灰色小字，带【】 -->
              <text wx:if="{{segment.type === 'narrative'}}" class="narrative-text">【{{segment.text}}】</text>
              <!-- 对话部分：正常大小，带"" -->
              <text wx:elif="{{segment.type === 'dialogue'}}" class="dialogue-text">"{{segment.text}}"</text>
            </block>
          </view>
          <!-- 兼容旧格式：如果没有 parsedContent，显示原始内容 -->
          <text wx:else>{{item.content}}</text>
        </view>
      </view>

      <!-- 用户消息 -->
      <view wx:else class="message user-message">
        <view class="bubble user-bubble">
          <text>{{item.content}}</text>
        </view>
        <view class="msg-avatar user-avatar-placeholder">我</view>
      </view>
    </view>

    <!-- AI思考中 -->
    <view wx:if="{{isThinking}}" class="message ai-message">
      <image class="msg-avatar" src="{{character.avatar}}" mode="aspectFill" />
      <view class="bubble ai-bubble thinking">
        <text class="dot"></text>
        <text class="dot"></text>
        <text class="dot"></text>
      </view>
    </view>

    <!-- 占位，确保最后一条消息可见 -->
    <view style="height: 20px;"></view>
  </scroll-view>

  <!-- 输入框区域 -->
  <view class="input-container">
    <!-- 🎮 快捷互动选项 -->
    <scroll-view
      wx:if="{{quickActions.length > 0}}"
      class="quick-actions"
      scroll-x
      show-scrollbar="{{false}}"
    >
      <view class="quick-actions-list">
        <button
          wx:for="{{quickActions}}"
          wx:key="*this"
          class="quick-action-btn"
          data-text="{{item}}"
          bindtap="selectQuickAction"
          hover-class="quick-action-hover"
        >
          {{item}}
        </button>
      </view>
    </scroll-view>

    <!-- 输入框 -->
    <view class="input-bar">
      <input
        class="input-field"
        type="text"
        placeholder="说点什么..."
        value="{{inputText}}"
        bindinput="onInput"
        confirm-type="send"
        bindconfirm="sendMessage"
        adjust-position="{{false}}"
      />
      <button
        class="send-btn {{inputText ? 'active' : ''}}"
        bindtap="sendMessage"
        disabled="{{!inputText || isThinking}}"
      >
        发送
      </button>
    </view>
  </view>
</view>